<?xml version="1.0" encoding="UTF-8"?>
<minitel>
  <layers id="game" left="0" top="1" width="40" height="22">
    
    <!-- Définition des caractères mosaïques -->
    <chardef name="sprites" type="mosaic">
      <!-- Envahisseur type 1 (6x3 = 3 chars): pieuvre -->
      <!-- 0: gauche -->
      <char>
        <line> #</line>
        <line># </line>
        <line># </line>
      </char>
      <!-- 1: centre -->
      <char>
        <line>##</line>
        <line>##</line>
        <line>  </line>
      </char>
      <!-- 2: droite -->
      <char>
        <line># </line>
        <line> #</line>
        <line> #</line>
      </char>
      
      <!-- Envahisseur type 2 (6x3 = 3 chars): crabe -->
      <!-- 3: gauche -->
      <char>
        <line># </line>
        <line>##</line>
        <line> #</line>
      </char>
      <!-- 4: centre -->
      <char>
        <line>##</line>
        <line>##</line>
        <line>##</line>
      </char>
      <!-- 5: droite -->
      <char>
        <line> #</line>
        <line>##</line>
        <line># </line>
      </char>
      
      <!-- Envahisseur type 3 (6x3 = 3 chars): méduse -->
      <!-- 6: gauche -->
      <char>
        <line> #</line>
        <line>##</line>
        <line># </line>
      </char>
      <!-- 7: centre -->
      <char>
        <line>##</line>
        <line>##</line>
        <line>##</line>
      </char>
      <!-- 8: droite -->
      <char>
        <line># </line>
        <line>##</line>
        <line> #</line>
      </char>
      
      <!-- Vaisseau (6x3 = 3 chars) -->
      <!-- 9: gauche -->
      <char>
        <line>  </line>
        <line>  </line>
        <line>##</line>
      </char>
      <!-- 10: centre -->
      <char>
        <line> #</line>
        <line>##</line>
        <line>##</line>
      </char>
      <!-- 11: droite -->
      <char>
        <line>  </line>
        <line>  </line>
        <line>##</line>
      </char>
      
      <!-- 12: Tir -->
      <char>
        <line> #</line>
        <line> #</line>
        <line> #</line>
      </char>
      
      <!-- 13: Explosion -->
      <char>
        <line># </line>
        <line> #</line>
        <line># </line>
      </char>
    </chardef>
    
    <!-- Map 0: Zone de jeu -->
    <map>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
      <row>                                        </row>
    </map>
    
    <!-- Labels -->
    <label id="score" x="1" y="0" width="12">Score: 0</label>
    <label id="lives" x="30" y="0" width="8">Vies: 3</label>
    <label id="gameover" x="12" y="10" width="16" visibility="hidden"></label>
    
    <!-- Contrôles -->
    <keypad action="LEFT" key="Q" event="moveLeft" />
    <keypad action="RIGHT" key="D" event="moveRight" />
    <keypad action="UP" key="Z" event="fire" />
    <keypad action="ACTION1" event="fire" />
    
    <!-- Game loop -->
    <timer event="gameLoop" interval="50"></timer>
    
  </layers>
  
  <div left="0" top="23" width="40" height="1">
    <row>  [Q]&lt; [D]&gt; [Z]Tir   KIWINVADERS    </row>
  </div>
  
  <script>
    // Dimensions
    var FIELD_LEFT = 1;
    var FIELD_RIGHT = 38;
    var FIELD_TOP = 2;
    var FIELD_BOTTOM = 19;
    var GAME_MAP = 0;
    
    // Configuration envahisseurs (3 rangées x 5 colonnes = 15)
    var ROWS = 3;
    var COLS = 5;
    var INV_WIDTH = 3;  // Largeur d'un envahisseur en caractères
    var SPACING = 7;    // Espacement entre envahisseurs
    var START_X = 3;
    var START_Y = 3;
    
    // Types d'envahisseurs par rangée (index du premier char)
    var TYPES = [0, 3, 6];  // Pieuvre, Crabe, Méduse
    // Couleurs par rangée
    var COLORS = [5, 6, 2];  // Magenta, Cyan, Vert
    var POINTS = [30, 20, 10];
    
    // Grille des envahisseurs
    var grid = [
      [true, true, true, true, true],
      [true, true, true, true, true],
      [true, true, true, true, true]
    ];
    var alive = 15;
    var dx = 1;
    
    // Joueur
    var shipX = 18;
    var shipY = 18;
    var SHIP_WIDTH = 3;
    
    // Tir joueur
    var bulletX = 0;
    var bulletY = 0;
    var bulletActive = false;
    
    // Tirs ennemis
    var eBullets = [
      {x:0, y:0, on:false},
      {x:0, y:0, on:false},
      {x:0, y:0, on:false},
      {x:0, y:0, on:false}
    ];
    
    // État
    var score = 0;
    var lives = 3;
    var gameOver = false;
    var tick = 0;
    
    function getLayers() { return _currentLayers; }
    
    function domReady() {
      var L = getLayers();
      if (!L) return;
      drawInvaders(L);
      drawShip(L);
    }
    
    function drawShip(L) {
      L.setMapPutchar(GAME_MAP, shipX, shipY, "sprites", 9);
      L.setMapColor(GAME_MAP, shipX, shipY, 7);
      L.setMapPutchar(GAME_MAP, shipX+1, shipY, "sprites", 10);
      L.setMapColor(GAME_MAP, shipX+1, shipY, 7);
      L.setMapPutchar(GAME_MAP, shipX+2, shipY, "sprites", 11);
      L.setMapColor(GAME_MAP, shipX+2, shipY, 7);
    }
    
    function clearShip(L) {
      L.setMapChar(GAME_MAP, shipX, shipY, ' ');
      L.setMapChar(GAME_MAP, shipX+1, shipY, ' ');
      L.setMapChar(GAME_MAP, shipX+2, shipY, ' ');
    }
    
    function drawInvader(L, x, y, type, color) {
      L.setMapPutchar(GAME_MAP, x, y, "sprites", type);
      L.setMapColor(GAME_MAP, x, y, color);
      L.setMapPutchar(GAME_MAP, x+1, y, "sprites", type+1);
      L.setMapColor(GAME_MAP, x+1, y, color);
      L.setMapPutchar(GAME_MAP, x+2, y, "sprites", type+2);
      L.setMapColor(GAME_MAP, x+2, y, color);
    }
    
    function clearInvader(L, x, y) {
      L.setMapChar(GAME_MAP, x, y, ' ');
      L.setMapChar(GAME_MAP, x+1, y, ' ');
      L.setMapChar(GAME_MAP, x+2, y, ' ');
    }
    
    function drawInvaders(L) {
      for (var r = 0; r < ROWS; r++) {
        var type = TYPES[r];
        var color = COLORS[r];
        var y = START_Y + r * 2;
        for (var c = 0; c < COLS; c++) {
          if (grid[r][c]) {
            var x = START_X + c * SPACING;
            drawInvader(L, x, y, type, color);
          }
        }
      }
    }
    
    function clearAllInvaders(L) {
      for (var r = 0; r < ROWS; r++) {
        var y = START_Y + r * 2;
        for (var c = 0; c < COLS; c++) {
          var x = START_X + c * SPACING;
          clearInvader(L, x, y);
        }
      }
    }
    
    function moveLeft() {
      if (gameOver) return;
      var L = getLayers();
      if (!L) return;
      if (shipX > FIELD_LEFT) {
        clearShip(L);
        shipX--;
        drawShip(L);
      }
    }
    
    function moveRight() {
      if (gameOver) return;
      var L = getLayers();
      if (!L) return;
      if (shipX < FIELD_RIGHT - SHIP_WIDTH) {
        clearShip(L);
        shipX++;
        drawShip(L);
      }
    }
    
    function fire() {
      if (gameOver || bulletActive) return;
      var L = getLayers();
      if (!L) return;
      bulletActive = true;
      bulletX = shipX + 1;
      bulletY = shipY - 1;
      L.setMapPutchar(GAME_MAP, bulletX, bulletY, "sprites", 12);
      L.setMapColor(GAME_MAP, bulletX, bulletY, 7);
    }
    
    function updateBullet(L) {
      if (!bulletActive) return;
      L.setMapChar(GAME_MAP, bulletX, bulletY, ' ');
      bulletY--;
      
      if (bulletY < FIELD_TOP) {
        bulletActive = false;
        return;
      }
      
      // Collision avec envahisseur
      for (var r = 0; r < ROWS; r++) {
        var y = START_Y + r * 2;
        if (bulletY != y) continue;
        for (var c = 0; c < COLS; c++) {
          if (!grid[r][c]) continue;
          var x = START_X + c * SPACING;
          // L'envahisseur fait 3 chars de large
          if (bulletX >= x && bulletX < x + INV_WIDTH) {
            grid[r][c] = false;
            alive--;
            score += POINTS[r];
            L.setText("score", "Score: " + score);
            // Explosion
            L.setMapPutchar(GAME_MAP, x+1, y, "sprites", 13);
            L.setMapColor(GAME_MAP, x+1, y, 3);
            clearInvader(L, x, y);
            bulletActive = false;
            L.beep();
            if (alive <= 0) {
              gameOver = true;
              L.setText("gameover", "  VICTOIRE!  ");
              L.showLabel("gameover");
            }
            return;
          }
        }
      }
      
      L.setMapPutchar(GAME_MAP, bulletX, bulletY, "sprites", 12);
      L.setMapColor(GAME_MAP, bulletX, bulletY, 7);
    }
    
    function updateEnemyBullets(L) {
      for (var i = 0; i < 4; i++) {
        var b = eBullets[i];
        if (!b.on) continue;
        L.setMapChar(GAME_MAP, b.x, b.y, ' ');
        b.y++;
        
        if (b.y > FIELD_BOTTOM) {
          b.on = false;
          continue;
        }
        
        // Collision joueur
        if (b.y == shipY && b.x >= shipX && b.x < shipX + SHIP_WIDTH) {
          b.on = false;
          lives--;
          L.setText("lives", "Vies: " + lives);
          L.beep();
          if (lives <= 0) {
            gameOver = true;
            L.setText("gameover", " GAME OVER! ");
            L.showLabel("gameover");
          }
          continue;
        }
        
        L.setMapPutchar(GAME_MAP, b.x, b.y, "sprites", 12);
        L.setMapColor(GAME_MAP, b.x, b.y, 1);
      }
    }
    
    function enemyFire(L) {
      var slot = -1;
      for (var i = 0; i < 4; i++) {
        if (!eBullets[i].on) { slot = i; break; }
      }
      if (slot < 0) return;
      
      var shooters = [];
      for (var r = 0; r < ROWS; r++) {
        for (var c = 0; c < COLS; c++) {
          if (grid[r][c]) {
            shooters.push({x: START_X + c * SPACING + 1, y: START_Y + r * 2});
          }
        }
      }
      if (shooters.length == 0) return;
      
      var s = shooters[Math.floor(Math.random() * shooters.length)];
      eBullets[slot].x = s.x;
      eBullets[slot].y = s.y + 1;
      eBullets[slot].on = true;
    }
    
    function moveInvaders(L) {
      var needReverse = false;
      
      for (var r = 0; r < ROWS; r++) {
        for (var c = 0; c < COLS; c++) {
          if (grid[r][c]) {
            var x = START_X + c * SPACING;
            if (dx > 0 && x + INV_WIDTH >= FIELD_RIGHT) needReverse = true;
            if (dx < 0 && x <= FIELD_LEFT) needReverse = true;
          }
        }
      }
      
      clearAllInvaders(L);
      
      if (needReverse) {
        dx = -dx;
        START_Y++;
        if (START_Y + (ROWS - 1) * 2 >= shipY - 1) {
          gameOver = true;
          L.setText("gameover", " INVASION! ");
          L.showLabel("gameover");
          return;
        }
      } else {
        START_X += dx;
      }
      
      drawInvaders(L);
    }
    
    function gameLoop() {
      if (gameOver) return;
      var L = getLayers();
      if (!L) return;
      
      tick++;
      
      updateBullet(L);
      updateEnemyBullets(L);
      
      if (tick % 8 == 0) {
        moveInvaders(L);
      }
      
      if (tick % 15 == 0) {
        enemyFire(L);
      }
    }
  </script>
</minitel>
